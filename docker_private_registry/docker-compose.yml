services:
  registry:
    image: registry:2
    container_name: registry
    ports:
      - "5000:5000"
    volumes:
      - /media/de/data/registry:/var/lib/registry
      - /media/de/data/registry/certs:/certs
      - /media/de/data/registry/config.yml:/etc/docker/registry/config.yml 
    restart: always
    environment:
      REGISTRY_HTTP_ADDR: :5000
      REGISTRY_HTTP_TLS_CERTIFICATE: /certs/domain.crt
      REGISTRY_HTTP_TLS_KEY: /certs/domain.key
    networks:
      - storage_network
    command: ["registry", "serve", "/etc/docker/registry/config.yml"]
    healthcheck:
      test: ["CMD-SHELL", "wget --no-check-certificate --no-verbose --tries=1 --spider https://localhost:5000/v2/_catalog || exit 1"]
      interval: 30s  
      timeout: 10s   
      retries: 3     
      start_period: 30s 

  # 인증서 다운로드를 위한 간단한 웹 서버
  cert-server:
    image: nginx:alpine
    container_name: registry-cert-server
    ports:
      - "9000:80"
    volumes:
      - /media/de/data/registry/certs:/usr/share/nginx/html/certs:ro
      - ./scripts:/usr/share/nginx/html/scripts:ro
      - ./docs:/usr/share/nginx/html/docs:ro
      - ./web/index.html:/usr/share/nginx/html/index.html:ro
      - ./web/certs-index.html:/usr/share/nginx/html/certs-index.html:ro
      - ./web/scripts-index.html:/usr/share/nginx/html/scripts-index.html:ro
      - ./web/docs-viewer.html:/usr/share/nginx/html/docs-viewer.html:ro
      - ./web/registry-list.html:/usr/share/nginx/html/registry-list.html:ro
      - ./web/css:/usr/share/nginx/html/css:ro
      - ./web/js:/usr/share/nginx/html/js:ro
      - ./config/nginx-cert-server.conf:/etc/nginx/conf.d/default.conf:ro
    networks:
      - storage_network
    restart: always
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/certs/domain.crt"]
      interval: 30s
      timeout: 10s
      retries: 3

networks:
  storage_network:
    driver: bridge
    external: true
