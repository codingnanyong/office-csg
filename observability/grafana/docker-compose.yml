services:
  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    user: "0:0"
    privileged: true
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=${GF_SECURITY_ADMIN_USER}           
      - GF_SECURITY_ADMIN_PASSWORD=${GF_SECURITY_ADMIN_PASSWORD}       
      - GF_PATHS_DATA=${GF_PATHS_DATA}
      - GF_RENDERER_PLUGIN_RENDERING_URL=http://renderer:8082/render  
      - GF_RENDERER_PLUGIN_RENDERING_CALLBACK_URL=http://grafana:3000
      - GF_METRICS_ENABLED=true
      - GF_METRICS_BASIC_AUTH_ENABLED=false
    volumes:
      - grafana_data:/var/lib/grafana
      - grafana_plugins:/var/lib/grafana/plugins        
      - grafana_provisioning:/etc/grafana/provisioning                           
      - ./img:/usr/share/grafana/public/img/bg:ro            
    restart: always
    networks:
      - grafana_network
    healthcheck:
      test: ["CMD", "curl", "--fail", "http://localhost:3000/api/health"]
      interval: 30s       
      timeout: 10s         
      retries: 3           
      start_period: 30s

  renderer:
    image: grafana/grafana-image-renderer:latest
    container_name: grafana-renderer
    environment:
      - ENABLE_METRICS=true
      - DISABLE_SANDBOX=true
      - HTTP_PORT=8082                             
    ports:
      - "8082:8082"                                     
    restart: always
    networks:
      - grafana_network
    healthcheck:
      test: ["CMD-SHELL", "node -e 'require(\"http\").request({host: \"127.0.0.1\", port: process.env.HTTP_PORT || 8082, path: \"/\"}, r => process.exit(r.statusCode === 200 ? 0 : 1)).on(\"error\", () => process.exit(1)).end()'" ] 
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

networks:
  grafana_network:
    driver: bridge
    external: true

volumes:
  grafana_data:
  grafana_plugins:
  grafana_provisioning:
